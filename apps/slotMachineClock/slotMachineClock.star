load("animation.star", "animation")
load("images/blank.png", BLANK_ASSET = "file")
load("images/hour_is_eight.png", HOUR_IS_EIGHT_ASSET = "file")
load("images/hour_is_five.png", HOUR_IS_FIVE_ASSET = "file")
load("images/hour_is_four.png", HOUR_IS_FOUR_ASSET = "file")
load("images/hour_is_nine.png", HOUR_IS_NINE_ASSET = "file")
load("images/hour_is_one.png", HOUR_IS_ONE_ASSET = "file")
load("images/hour_is_seven.png", HOUR_IS_SEVEN_ASSET = "file")
load("images/hour_is_six.png", HOUR_IS_SIX_ASSET = "file")
load("images/hour_is_three.png", HOUR_IS_THREE_ASSET = "file")
load("images/hour_is_two.png", HOUR_IS_TWO_ASSET = "file")
load("images/hour_is_zero.png", HOUR_IS_ZERO_ASSET = "file")
load("images/hour_loop.gif", HOUR_LOOP_ASSET = "file")
load("images/hour_start.png", HOUR_START_ASSET = "file")
load("images/hour_to_eight.gif", HOUR_TO_EIGHT_ASSET = "file")
load("images/hour_to_five.gif", HOUR_TO_FIVE_ASSET = "file")
load("images/hour_to_four.gif", HOUR_TO_FOUR_ASSET = "file")
load("images/hour_to_nine.gif", HOUR_TO_NINE_ASSET = "file")
load("images/hour_to_one.gif", HOUR_TO_ONE_ASSET = "file")
load("images/hour_to_seven.gif", HOUR_TO_SEVEN_ASSET = "file")
load("images/hour_to_six.gif", HOUR_TO_SIX_ASSET = "file")
load("images/hour_to_three.gif", HOUR_TO_THREE_ASSET = "file")
load("images/hour_to_two.gif", HOUR_TO_TWO_ASSET = "file")
load("images/hour_to_zero.gif", HOUR_TO_ZERO_ASSET = "file")
load("images/lever.png", LEVER_ASSET = "file")
load("images/lever_pull.gif", LEVER_PULL_ASSET = "file")
load("images/minute_is_eight.png", MINUTE_IS_EIGHT_ASSET = "file")
load("images/minute_is_five.png", MINUTE_IS_FIVE_ASSET = "file")
load("images/minute_is_four.png", MINUTE_IS_FOUR_ASSET = "file")
load("images/minute_is_nine.png", MINUTE_IS_NINE_ASSET = "file")
load("images/minute_is_one.png", MINUTE_IS_ONE_ASSET = "file")
load("images/minute_is_seven.png", MINUTE_IS_SEVEN_ASSET = "file")
load("images/minute_is_six.png", MINUTE_IS_SIX_ASSET = "file")
load("images/minute_is_three.png", MINUTE_IS_THREE_ASSET = "file")
load("images/minute_is_two.png", MINUTE_IS_TWO_ASSET = "file")
load("images/minute_is_zero.png", MINUTE_IS_ZERO_ASSET = "file")
load("images/minute_loop.gif", MINUTE_LOOP_ASSET = "file")
load("images/minute_start.png", MINUTE_START_ASSET = "file")
load("images/minute_to_eight.gif", MINUTE_TO_EIGHT_ASSET = "file")
load("images/minute_to_five.gif", MINUTE_TO_FIVE_ASSET = "file")
load("images/minute_to_four.gif", MINUTE_TO_FOUR_ASSET = "file")
load("images/minute_to_nine.gif", MINUTE_TO_NINE_ASSET = "file")
load("images/minute_to_one.gif", MINUTE_TO_ONE_ASSET = "file")
load("images/minute_to_seven.gif", MINUTE_TO_SEVEN_ASSET = "file")
load("images/minute_to_six.gif", MINUTE_TO_SIX_ASSET = "file")
load("images/minute_to_three.gif", MINUTE_TO_THREE_ASSET = "file")
load("images/minute_to_two.gif", MINUTE_TO_TWO_ASSET = "file")
load("images/minute_to_zero.gif", MINUTE_TO_ZERO_ASSET = "file")
load("images/spacer.png", SPACER_ASSET = "file")
load("images/ten_hour_is_blank.png", TEN_HOUR_IS_BLANK_ASSET = "file")
load("images/ten_hour_is_one.png", TEN_HOUR_IS_ONE_ASSET = "file")
load("images/ten_hour_loop.gif", TEN_HOUR_LOOP_ASSET = "file")
load("images/ten_hour_start.png", TEN_HOUR_START_ASSET = "file")
load("images/ten_hour_to_blank.gif", TEN_HOUR_TO_BLANK_ASSET = "file")
load("images/ten_hour_to_one.gif", TEN_HOUR_TO_ONE_ASSET = "file")
load("images/ten_minute_is_five.png", TEN_MINUTE_IS_FIVE_ASSET = "file")
load("images/ten_minute_is_four.png", TEN_MINUTE_IS_FOUR_ASSET = "file")
load("images/ten_minute_is_one.png", TEN_MINUTE_IS_ONE_ASSET = "file")
load("images/ten_minute_is_three.png", TEN_MINUTE_IS_THREE_ASSET = "file")
load("images/ten_minute_is_two.png", TEN_MINUTE_IS_TWO_ASSET = "file")
load("images/ten_minute_is_zero.png", TEN_MINUTE_IS_ZERO_ASSET = "file")
load("images/ten_minute_loop.gif", TEN_MINUTE_LOOP_ASSET = "file")
load("images/ten_minute_start.png", TEN_MINUTE_START_ASSET = "file")
load("images/ten_minute_to_five.gif", TEN_MINUTE_TO_FIVE_ASSET = "file")
load("images/ten_minute_to_four.gif", TEN_MINUTE_TO_FOUR_ASSET = "file")
load("images/ten_minute_to_one.gif", TEN_MINUTE_TO_ONE_ASSET = "file")
load("images/ten_minute_to_three.gif", TEN_MINUTE_TO_THREE_ASSET = "file")
load("images/ten_minute_to_two.gif", TEN_MINUTE_TO_TWO_ASSET = "file")
load("images/ten_minute_to_zero.gif", TEN_MINUTE_TO_ZERO_ASSET = "file")
load("render.star", "render")
load("schema.star", "schema")
load("time.star", "time")

BLANK = BLANK_ASSET.readall()
HOUR_IS_EIGHT = HOUR_IS_EIGHT_ASSET.readall()
HOUR_IS_FIVE = HOUR_IS_FIVE_ASSET.readall()
HOUR_IS_FOUR = HOUR_IS_FOUR_ASSET.readall()
HOUR_IS_NINE = HOUR_IS_NINE_ASSET.readall()
HOUR_IS_ONE = HOUR_IS_ONE_ASSET.readall()
HOUR_IS_SEVEN = HOUR_IS_SEVEN_ASSET.readall()
HOUR_IS_SIX = HOUR_IS_SIX_ASSET.readall()
HOUR_IS_THREE = HOUR_IS_THREE_ASSET.readall()
HOUR_IS_TWO = HOUR_IS_TWO_ASSET.readall()
HOUR_IS_ZERO = HOUR_IS_ZERO_ASSET.readall()
HOUR_LOOP = HOUR_LOOP_ASSET.readall()
HOUR_START = HOUR_START_ASSET.readall()
HOUR_TO_EIGHT = HOUR_TO_EIGHT_ASSET.readall()
HOUR_TO_FIVE = HOUR_TO_FIVE_ASSET.readall()
HOUR_TO_FOUR = HOUR_TO_FOUR_ASSET.readall()
HOUR_TO_NINE = HOUR_TO_NINE_ASSET.readall()
HOUR_TO_ONE = HOUR_TO_ONE_ASSET.readall()
HOUR_TO_SEVEN = HOUR_TO_SEVEN_ASSET.readall()
HOUR_TO_SIX = HOUR_TO_SIX_ASSET.readall()
HOUR_TO_THREE = HOUR_TO_THREE_ASSET.readall()
HOUR_TO_TWO = HOUR_TO_TWO_ASSET.readall()
HOUR_TO_ZERO = HOUR_TO_ZERO_ASSET.readall()
LEVER = LEVER_ASSET.readall()
LEVER_PULL = LEVER_PULL_ASSET.readall()
MINUTE_IS_EIGHT = MINUTE_IS_EIGHT_ASSET.readall()
MINUTE_IS_FIVE = MINUTE_IS_FIVE_ASSET.readall()
MINUTE_IS_FOUR = MINUTE_IS_FOUR_ASSET.readall()
MINUTE_IS_NINE = MINUTE_IS_NINE_ASSET.readall()
MINUTE_IS_ONE = MINUTE_IS_ONE_ASSET.readall()
MINUTE_IS_SEVEN = MINUTE_IS_SEVEN_ASSET.readall()
MINUTE_IS_SIX = MINUTE_IS_SIX_ASSET.readall()
MINUTE_IS_THREE = MINUTE_IS_THREE_ASSET.readall()
MINUTE_IS_TWO = MINUTE_IS_TWO_ASSET.readall()
MINUTE_IS_ZERO = MINUTE_IS_ZERO_ASSET.readall()
MINUTE_LOOP = MINUTE_LOOP_ASSET.readall()
MINUTE_START = MINUTE_START_ASSET.readall()
MINUTE_TO_EIGHT = MINUTE_TO_EIGHT_ASSET.readall()
MINUTE_TO_FIVE = MINUTE_TO_FIVE_ASSET.readall()
MINUTE_TO_FOUR = MINUTE_TO_FOUR_ASSET.readall()
MINUTE_TO_NINE = MINUTE_TO_NINE_ASSET.readall()
MINUTE_TO_ONE = MINUTE_TO_ONE_ASSET.readall()
MINUTE_TO_SEVEN = MINUTE_TO_SEVEN_ASSET.readall()
MINUTE_TO_SIX = MINUTE_TO_SIX_ASSET.readall()
MINUTE_TO_THREE = MINUTE_TO_THREE_ASSET.readall()
MINUTE_TO_TWO = MINUTE_TO_TWO_ASSET.readall()
MINUTE_TO_ZERO = MINUTE_TO_ZERO_ASSET.readall()
SPACER = SPACER_ASSET.readall()
TEN_HOUR_IS_BLANK = TEN_HOUR_IS_BLANK_ASSET.readall()
TEN_HOUR_IS_ONE = TEN_HOUR_IS_ONE_ASSET.readall()
TEN_HOUR_LOOP = TEN_HOUR_LOOP_ASSET.readall()
TEN_HOUR_START = TEN_HOUR_START_ASSET.readall()
TEN_HOUR_TO_BLANK = TEN_HOUR_TO_BLANK_ASSET.readall()
TEN_HOUR_TO_ONE = TEN_HOUR_TO_ONE_ASSET.readall()
TEN_MINUTE_IS_FIVE = TEN_MINUTE_IS_FIVE_ASSET.readall()
TEN_MINUTE_IS_FOUR = TEN_MINUTE_IS_FOUR_ASSET.readall()
TEN_MINUTE_IS_ONE = TEN_MINUTE_IS_ONE_ASSET.readall()
TEN_MINUTE_IS_THREE = TEN_MINUTE_IS_THREE_ASSET.readall()
TEN_MINUTE_IS_TWO = TEN_MINUTE_IS_TWO_ASSET.readall()
TEN_MINUTE_IS_ZERO = TEN_MINUTE_IS_ZERO_ASSET.readall()
TEN_MINUTE_LOOP = TEN_MINUTE_LOOP_ASSET.readall()
TEN_MINUTE_START = TEN_MINUTE_START_ASSET.readall()
TEN_MINUTE_TO_FIVE = TEN_MINUTE_TO_FIVE_ASSET.readall()
TEN_MINUTE_TO_FOUR = TEN_MINUTE_TO_FOUR_ASSET.readall()
TEN_MINUTE_TO_ONE = TEN_MINUTE_TO_ONE_ASSET.readall()
TEN_MINUTE_TO_THREE = TEN_MINUTE_TO_THREE_ASSET.readall()
TEN_MINUTE_TO_TWO = TEN_MINUTE_TO_TWO_ASSET.readall()
TEN_MINUTE_TO_ZERO = TEN_MINUTE_TO_ZERO_ASSET.readall()

def main(config):
    speed = int(config.str("speed", 2))  #takes user input equating to how many loops to spin before displaying time
    timezone = time.tz()

    current_time = get_current_time_as_tuple(timezone)
    ten_hour_value = current_time[0]
    hour_value = current_time[1]
    ten_minute_value = current_time[2]
    minute_value = current_time[3]

    ten_hour_images = set_ten_hour_images(ten_hour_value)  #call helper functions to determine which images to use depending on the time
    hour_images = set_hour_images(hour_value)
    ten_minute_images = set_ten_minute_images(ten_minute_value)
    minute_images = set_minute_images(minute_value)
    spacer_images = [SPACER, SPACER, SPACER]  #because these dont change on the time, we can directly set their values
    lever_images = [LEVER, LEVER_PULL, LEVER]

    ten_hour_frames = render_frame_list(ten_hour_images, 0, 15, 22, speed, 24)  #turn the images into an Animation object so we can play them side-by-side in a Row
    hour_frames = render_frame_list(hour_images, 13, 20, 23, speed, 24)  #and adds in the loops to each animation
    spacer_frames = render_frame_list(spacer_images, 26, 0, 0, speed, 48)  #also inserts the wait time before subsequent slots start
    ten_minute_frames = render_frame_list(ten_minute_images, 30, 25, 22, speed, 24)
    minute_frames = render_frame_list(minute_images, 43, 30, 24, speed, 29)
    lever_frames = render_frame_list(lever_images, 56, 0, 15, speed, 0)

    return render.Root(
        child = render.Stack(
            children = [
                render.Sequence(
                    children = lever_frames,  #must be rendered right to left so that the spacing blank images are drawn over, and they dont draw over our clock
                ),
                render.Sequence(
                    children = minute_frames,
                ),
                render.Sequence(
                    children = ten_minute_frames,
                ),
                render.Sequence(
                    children = spacer_frames,
                ),
                render.Sequence(
                    children = hour_frames,
                ),
                render.Sequence(
                    children = ten_hour_frames,
                ),
            ],
        ),
    )

def render_frame(image, position, frames):  #given an image, its horizontal displacement, and its frame length
    renderedImage = render.Image(image)  #returns an Animation object displaced the correct amount with white
    blank_image = render.Image(BLANK)  #spacing image, meant to be drawn over in a Stack
    trans_child_children = [
        renderedImage,
    ]
    for _ in range(position):
        trans_child_children.insert(0, blank_image)
    return animation.Transformation(
        duration = frames,
        delay = 0,
        keyframes = [],
        child = render.Row(
            main_align = "start",
            cross_align = "center",
            children = trans_child_children,
        ),
    )

def render_frame_list(images, position, waitTime, movementFrames, loops, loopFrames):  #combines the starting frame, looping
    new_frames = []  #gif, finishing gif, and final frame
    new_frames.append(render_frame(images[0], position, waitTime))  #all into one list of Animation objects.
    if (len(images) > 3):  #Meant to be played as a Sequence
        for _ in range(loops):
            new_frames.append(render_frame(images[3], position, loopFrames))
    new_frames.append(render_frame(images[1], position, movementFrames))
    new_frames.append(render_frame(images[2], position, 1500))
    return new_frames

def get_schema():
    options = [
        schema.Option(
            display = "Slow",  #Slow speed = 3 loops before displaying time
            value = "3",
        ),
        schema.Option(
            display = "Medium",  #Medium = 2 loops...etc
            value = "2",
        ),
        schema.Option(
            display = "Fast",
            value = "1",
        ),
    ]
    return schema.Schema(
        version = "1",
        fields = [
            schema.Dropdown(
                id = "speed",
                name = "Speed of slot machine",
                desc = "Determines how long to spin before it takes to land on the time",
                icon = "forwardFast",
                default = options[1].value,
                options = options,
            ),
        ],
    )  #returns the time as a tuple of each digit

def get_current_time_as_tuple(timezone):
    tz_now = time.now().in_location(timezone)
    total_hour = list(tz_now.format("3:04").partition(":")[0].elems())  #gets the hour as a list of single character strings
    ten_hour_value = 0
    hour_value = int(total_hour[0])
    if (len(total_hour) == 2):  #if theres a ten's digit for hours, set ten_hour to 1 and fix hour
        ten_hour_value = 1
        hour_value = int(total_hour[1])
    total_minute = list(time.now().format("3:04").partition(":")[2].elems())  #gets minute at a list of single character strings
    ten_minute_value = int(total_minute[0])
    minute_value = int(total_minute[1])
    return (ten_hour_value, hour_value, ten_minute_value, minute_value)

def swap_time(old_images, new_movement, new_final):  #swaps out middle 2 values in list with new given values
    old_images.pop(2)
    old_images.pop(1)
    old_images.insert(1, new_movement)
    old_images.insert(2, new_final)
    return old_images

def set_ten_hour_images(ten_hour_value):
    return_images = [TEN_HOUR_START, TEN_HOUR_TO_BLANK, TEN_HOUR_IS_BLANK, TEN_HOUR_LOOP]
    if (ten_hour_value == 1):
        return_images = swap_time(return_images, TEN_HOUR_TO_ONE, TEN_HOUR_IS_ONE)
    return return_images

def set_hour_images(hour_value):
    return_images = [HOUR_START, HOUR_TO_ZERO, HOUR_IS_ZERO, HOUR_LOOP]
    if (hour_value == 1):
        return_images = swap_time(return_images, HOUR_TO_ONE, HOUR_IS_ONE)  # Would love to use a switch statement
    elif (hour_value == 2):  # for all these functions, but as far as
        return_images = swap_time(return_images, HOUR_TO_TWO, HOUR_IS_TWO)  # I can tell, Starlark doesnt support switch statements
    elif (hour_value == 3):
        return_images = swap_time(return_images, HOUR_TO_THREE, HOUR_IS_THREE)
    elif (hour_value == 4):
        return_images = swap_time(return_images, HOUR_TO_FOUR, HOUR_IS_FOUR)
    elif (hour_value == 5):
        return_images = swap_time(return_images, HOUR_TO_FIVE, HOUR_IS_FIVE)
    elif (hour_value == 6):
        return_images = swap_time(return_images, HOUR_TO_SIX, HOUR_IS_SIX)
    elif (hour_value == 7):
        return_images = swap_time(return_images, HOUR_TO_SEVEN, HOUR_IS_SEVEN)
    elif (hour_value == 8):
        return_images = swap_time(return_images, HOUR_TO_EIGHT, HOUR_IS_EIGHT)
    elif (hour_value == 9):
        return_images = swap_time(return_images, HOUR_TO_NINE, HOUR_IS_NINE)
    return return_images

def set_ten_minute_images(ten_minute_value):
    return_images = [TEN_MINUTE_START, TEN_MINUTE_TO_ZERO, TEN_MINUTE_IS_ZERO, TEN_MINUTE_LOOP]
    if (ten_minute_value == 1):
        return_images = swap_time(return_images, TEN_MINUTE_TO_ONE, TEN_MINUTE_IS_ONE)
    elif (ten_minute_value == 2):
        return_images = swap_time(return_images, TEN_MINUTE_TO_TWO, TEN_MINUTE_IS_TWO)
    elif (ten_minute_value == 3):
        return_images = swap_time(return_images, TEN_MINUTE_TO_THREE, TEN_MINUTE_IS_THREE)
    elif (ten_minute_value == 4):
        return_images = swap_time(return_images, TEN_MINUTE_TO_FOUR, TEN_MINUTE_IS_FOUR)
    elif (ten_minute_value == 5):
        return_images = swap_time(return_images, TEN_MINUTE_TO_FIVE, TEN_MINUTE_IS_FIVE)
    return return_images

def set_minute_images(minute_value):
    return_images = [MINUTE_START, MINUTE_TO_ZERO, MINUTE_IS_ZERO, MINUTE_LOOP]
    if (minute_value == 1):
        return_images = swap_time(return_images, MINUTE_TO_ONE, MINUTE_IS_ONE)
    elif (minute_value == 2):
        return_images = swap_time(return_images, MINUTE_TO_TWO, MINUTE_IS_TWO)
    elif (minute_value == 3):
        return_images = swap_time(return_images, MINUTE_TO_THREE, MINUTE_IS_THREE)
    elif (minute_value == 4):
        return_images = swap_time(return_images, MINUTE_TO_FOUR, MINUTE_IS_FOUR)
    elif (minute_value == 5):
        return_images = swap_time(return_images, MINUTE_TO_FIVE, MINUTE_IS_FIVE)
    elif (minute_value == 6):
        return_images = swap_time(return_images, MINUTE_TO_SIX, MINUTE_IS_SIX)
    elif (minute_value == 7):
        return_images = swap_time(return_images, MINUTE_TO_SEVEN, MINUTE_IS_SEVEN)
    elif (minute_value == 8):
        return_images = swap_time(return_images, MINUTE_TO_EIGHT, MINUTE_IS_EIGHT)
    elif (minute_value == 9):
        return_images = swap_time(return_images, MINUTE_TO_NINE, MINUTE_IS_NINE)
    return return_images
